# Generating merge scripts for Reference Data


## Overview
Reference data in a database is static information used for validation and categorization of other data, providing consistency and context.

This document explains the process of copying and synchronizing reference data. In this project, the reference data is imported in new databases but is also used to update an existing database, making sure the reference data is the same in each environment. 


## Prerequisites - Stored Procedure usp_generate_merge
The [HRSC_APP].[usp_generate_merge] stored procedure generates a MERGE statement based on existing data in a specified table or view. The generated MERGE statement can be used to synchronize data between the source and target tables by inserting new rows, updating existing rows, and optionally deleting unmatched rows.

Example Usage:
```SQL
EXEC [HRSC_APP].[usp_generate_merge]
  @table_name = 'CD_HR_GUIDE_TYPE',
  @schema = 'HRSC',
  @delete_if_not_matched = 0,
  @include_use_db = 0,
  @results_to_text = 0; 
```


Script generated for the [CD_HR_GUIDE_TYPE] table:

```SQL 
--MERGE generated by 'sp_generate_merge' stored procedure
--Originally by Vyas (http://vyaskn.tripod.com/code): sp_generate_inserts (build 22)
--Adapted for SQL Server 2008+ by Daniel Nolan (https://twitter.com/dnlnln)

SET NOCOUNT ON

SET IDENTITY_INSERT [HRSC].[CD_HR_GUIDE_TYPE] ON

DECLARE @mergeOutput1901249828 TABLE ( [DMLAction] VARCHAR(6) );
MERGE INTO [HRSC].[CD_HR_GUIDE_TYPE] AS [Target]
USING (VALUES
  (2,N'MG',N'Guide',N'Guide',N'Manager''s Guide',N'Guide du gestionnaire',NULL,NULL,N'Jan  9 2013  3:08PM','2013-01-09T15:08:59.977',NULL,NULL)
 ,(3,N'PR',N'Procedure',N'Procédure',N'HR Desk Procedure',N'Procédure HR',NULL,NULL,N'Jan  9 2013  3:10PM','2013-01-09T15:10:30.047',NULL,NULL)
 ,(4,N'FI',N'Form Instructions',N'Instructions du Formulaire',N'Form Instructions',N'Instructions du Formulaire',NULL,NULL,N'system','2021-02-05T07:35:50.540',NULL,NULL)
) AS [Source] ([HR_GUIDE_TYPE_ID],[HR_GUIDE_TYPE_CODE],[HR_GUIDE_TYPE_NAME_EN],[HR_GUIDE_TYPE_NAME_FR],[HR_GUIDE_TYPE_DESC_EN],[HR_GUIDE_TYPE_DESC_FR],[EFFECTIVE_DATE],[EXPIRY_DATE],[USER_CREATED],[DATE_CREATED],[USER_UPDATED],[DATE_UPDATED])
ON ([Target].[HR_GUIDE_TYPE_ID] = [Source].[HR_GUIDE_TYPE_ID])
WHEN MATCHED AND (
	NULLIF([Source].[HR_GUIDE_TYPE_CODE], [Target].[HR_GUIDE_TYPE_CODE]) IS NOT NULL OR NULLIF([Target].[HR_GUIDE_TYPE_CODE], [Source].[HR_GUIDE_TYPE_CODE]) IS NOT NULL OR 
	NULLIF([Source].[HR_GUIDE_TYPE_NAME_EN], [Target].[HR_GUIDE_TYPE_NAME_EN]) IS NOT NULL OR NULLIF([Target].[HR_GUIDE_TYPE_NAME_EN], [Source].[HR_GUIDE_TYPE_NAME_EN]) IS NOT NULL OR 
	NULLIF([Source].[HR_GUIDE_TYPE_NAME_FR], [Target].[HR_GUIDE_TYPE_NAME_FR]) IS NOT NULL OR NULLIF([Target].[HR_GUIDE_TYPE_NAME_FR], [Source].[HR_GUIDE_TYPE_NAME_FR]) IS NOT NULL OR 
	NULLIF([Source].[HR_GUIDE_TYPE_DESC_EN], [Target].[HR_GUIDE_TYPE_DESC_EN]) IS NOT NULL OR NULLIF([Target].[HR_GUIDE_TYPE_DESC_EN], [Source].[HR_GUIDE_TYPE_DESC_EN]) IS NOT NULL OR 
	NULLIF([Source].[HR_GUIDE_TYPE_DESC_FR], [Target].[HR_GUIDE_TYPE_DESC_FR]) IS NOT NULL OR NULLIF([Target].[HR_GUIDE_TYPE_DESC_FR], [Source].[HR_GUIDE_TYPE_DESC_FR]) IS NOT NULL OR 
	NULLIF([Source].[EFFECTIVE_DATE], [Target].[EFFECTIVE_DATE]) IS NOT NULL OR NULLIF([Target].[EFFECTIVE_DATE], [Source].[EFFECTIVE_DATE]) IS NOT NULL OR 
	NULLIF([Source].[EXPIRY_DATE], [Target].[EXPIRY_DATE]) IS NOT NULL OR NULLIF([Target].[EXPIRY_DATE], [Source].[EXPIRY_DATE]) IS NOT NULL OR 
	NULLIF([Source].[USER_CREATED], [Target].[USER_CREATED]) IS NOT NULL OR NULLIF([Target].[USER_CREATED], [Source].[USER_CREATED]) IS NOT NULL OR 
	NULLIF([Source].[DATE_CREATED], [Target].[DATE_CREATED]) IS NOT NULL OR NULLIF([Target].[DATE_CREATED], [Source].[DATE_CREATED]) IS NOT NULL OR 
	NULLIF([Source].[USER_UPDATED], [Target].[USER_UPDATED]) IS NOT NULL OR NULLIF([Target].[USER_UPDATED], [Source].[USER_UPDATED]) IS NOT NULL OR 
	NULLIF([Source].[DATE_UPDATED], [Target].[DATE_UPDATED]) IS NOT NULL OR NULLIF([Target].[DATE_UPDATED], [Source].[DATE_UPDATED]) IS NOT NULL) THEN
 UPDATE SET
  [Target].[HR_GUIDE_TYPE_CODE] = [Source].[HR_GUIDE_TYPE_CODE], 
  [Target].[HR_GUIDE_TYPE_NAME_EN] = [Source].[HR_GUIDE_TYPE_NAME_EN], 
  [Target].[HR_GUIDE_TYPE_NAME_FR] = [Source].[HR_GUIDE_TYPE_NAME_FR], 
  [Target].[HR_GUIDE_TYPE_DESC_EN] = [Source].[HR_GUIDE_TYPE_DESC_EN], 
  [Target].[HR_GUIDE_TYPE_DESC_FR] = [Source].[HR_GUIDE_TYPE_DESC_FR], 
  [Target].[EFFECTIVE_DATE] = [Source].[EFFECTIVE_DATE], 
  [Target].[EXPIRY_DATE] = [Source].[EXPIRY_DATE], 
  [Target].[USER_CREATED] = [Source].[USER_CREATED], 
  [Target].[DATE_CREATED] = [Source].[DATE_CREATED], 
  [Target].[USER_UPDATED] = [Source].[USER_UPDATED], 
  [Target].[DATE_UPDATED] = [Source].[DATE_UPDATED]
WHEN NOT MATCHED BY TARGET THEN
 INSERT([HR_GUIDE_TYPE_ID],[HR_GUIDE_TYPE_CODE],[HR_GUIDE_TYPE_NAME_EN],[HR_GUIDE_TYPE_NAME_FR],[HR_GUIDE_TYPE_DESC_EN],[HR_GUIDE_TYPE_DESC_FR],[EFFECTIVE_DATE],[EXPIRY_DATE],[USER_CREATED],[DATE_CREATED],[USER_UPDATED],[DATE_UPDATED])
 VALUES([Source].[HR_GUIDE_TYPE_ID],[Source].[HR_GUIDE_TYPE_CODE],[Source].[HR_GUIDE_TYPE_NAME_EN],[Source].[HR_GUIDE_TYPE_NAME_FR],[Source].[HR_GUIDE_TYPE_DESC_EN],[Source].[HR_GUIDE_TYPE_DESC_FR],[Source].[EFFECTIVE_DATE],[Source].[EXPIRY_DATE],[Source].[USER_CREATED],[Source].[DATE_CREATED],[Source].[USER_UPDATED],[Source].[DATE_UPDATED])
OUTPUT $action INTO @mergeOutput1901249828;

DECLARE @mergeError1901249828 int,
@mergeCount1901249828 int,
@mergeCountIns1901249828 int,
@mergeCountUpd1901249828 int,
@mergeCountDel1901249828 int
SELECT @mergeError1901249828 = @@ERROR
SELECT @mergeCount1901249828 = COUNT(1), @mergeCountIns1901249828 = SUM(IIF([DMLAction] = 'INSERT', 1, 0)), @mergeCountUpd1901249828 = SUM(IIF([DMLAction] = 'UPDATE', 1, 0)), @mergeCountDel1901249828 = SUM (IIF([DMLAction] = 'DELETE', 1, 0)) FROM @mergeOutput1901249828
IF @mergeError1901249828 != 0
 BEGIN
 PRINT 'ERROR OCCURRED IN MERGE FOR [HRSC].[CD_HR_GUIDE_TYPE]. Rows affected: ' + CAST(@mergeCount1901249828 AS VARCHAR(100)); -- SQL should always return zero rows affected
 END
ELSE
 BEGIN
 PRINT '[HRSC].[CD_HR_GUIDE_TYPE] rows affected by MERGE: ' + CAST(COALESCE(@mergeCount1901249828,0) AS VARCHAR(100)) + ' (Inserted: ' + CAST(COALESCE(@mergeCountIns1901249828,0) AS VARCHAR(100)) + '; Updated: ' + CAST(COALESCE(@mergeCountUpd1901249828,0) AS VARCHAR(100)) + '; Deleted: ' + CAST(COALESCE(@mergeCountDel1901249828,0) AS VARCHAR(100)) + ')' ;
 END

SET IDENTITY_INSERT [HRSC].[CD_HR_GUIDE_TYPE] OFF
SET NOCOUNT OFF
```

**Credits**

The code and documentation for the usp_generate_merge stored procedure can be found on GitHub [here](https://github.com/readyroll/generate-sql-merge/tree/master). Credits to [readyroll](https://github.com/readyroll).


## Generate MERGE scripts into files

To ease the process of creating all of the sql files in the project, a Powershell script has been created to automate all of this. The script can be found in the utils directory of the project and you can with it [here](../../utils/GenerateReferenceData.ps1).

To use the script, open a Powershell window and execute the following, using the connection string of the source database:

Example:
```Powershell
PS C:\_DEV\hrsc-database\utils> .\GenerateReferenceData.ps1  "Data Source=localhost\SQLEXPRESS;Initial Catalog=HRSC;Integrated Security=true;"
```

The files will be generated under C:\Temp\ReferenceData. You can edit the script to output the files to a diferent place. 

Once the files have been created, they need to be copied into the Scripts/Seed folder inside the project.


## Execute merge script through the Post-Deployment script

The reference data files are located in the Scripts/Seed folder within the project structure. 

These generated files are used through the post-deployment script in the project to synchronize the data. **This should only be used in developement environments**.

```SQL
if @@servername <> 'MLDBSQL16CL01' -- Production and training
begin 
    PRINT 'BEGIN Merge lookup data scripts'
    /*
    Insert lookup data. Allowed on dev environments only.
    */
    :r ./"Seed/HRSC.CD_ACADEMIC_LEVEL.Table.sql"
    :r ./"Seed/HRSC.CD_ACCOMODATION_REQUIRED.Table.sql"
    :r ./"Seed/HRSC.CD_ACTION_TYPE.Table.sql"
    :r ./"Seed/HRSC.CD_ANNOUNCEMENT_TYPE.Table.sql"
    ...
```

The condition **@@servername <> 'MLDBSQL16CL01'** ensures this code is not ran on a production environment. 

See [PostDeployment.sql](../../src/Scripts/PostDeployment.sql) for more details.


## Additional information

If, when publishing, you see that all of the french accents have been replaced with a "?", make sure all of the seed files are saved using the UTF-8 encoding. You need to open each file, select the small dropdown in the "Save as" button, and choose "Save with encoding".